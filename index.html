<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Viewer Reservasi Dolan Sawah (Photo View)</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <style>
    :root {
      --primary: #2a9d8f; 
      --primary-dark: #203a43; 
      --secondary: #e9c46a; 
      --highlight: #d35400; 
      --danger: #c0392b; 
      --danger-light: #fadbd8;
      --success: #27ae60;
      --warning: #f39c12;
      --bg-body: #f4f6f8; 
      --bg-card: #ffffff; 
      --text-main: #2d3436; 
      --text-muted: #636e72;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
      font-family: 'Poppins', sans-serif; 
      margin: 0; 
      background-color: var(--bg-body); 
      color: var(--text-main); 
      overflow-x: hidden; 
      padding-bottom: 80px; 
    }
    
    /* --- HEADER --- */
    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary)); 
      padding: 15px 20px 40px; 
      color: white;
      border-bottom-left-radius: 30px; 
      border-bottom-right-radius: 30px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    .header-branding h2 { margin: 0; font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .header-branding small { opacity: 0.9; font-size: 0.8rem; margin-top: 4px; font-weight: 300; }
    
    /* --- KALENDER CONTAINER --- */
    .main-container { max-width: 800px; margin: -30px auto 0; padding: 0 15px; position: relative; z-index: 10; }
    
    /* --- INFO CARD ANIMATION (NEW) --- */
    @keyframes gentle-wobble {
        0% { transform: translateX(0%); }
        15% { transform: translateX(-3px) rotate(-2deg); }
        30% { transform: translateX(3px) rotate(2deg); }
        45% { transform: translateX(-3px) rotate(-2deg); }
        60% { transform: translateX(2px) rotate(1deg); }
        75% { transform: translateX(-1px); }
        100% { transform: translateX(0%); }
    }

    .info-card {
        background: white;
        border-radius: 20px;
        padding: 15px 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        display: flex;
        align-items: flex-start;
        gap: 15px;
        border-left: 5px solid var(--primary);
        /* Animasi: durasi 3 detik, infinite agar terus menarik perhatian */
        animation: gentle-wobble 3s infinite ease-in-out;
        transform-origin: center center;
    }
    .info-icon {
        background: rgba(42, 157, 143, 0.1); 
        width: 40px; height: 40px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0;
        color: var(--primary);
        font-size: 1.2rem;
    }
    .info-content h4 { margin: 0 0 5px 0; font-size: 0.95rem; color: var(--primary-dark); }
    .info-content p { margin: 0; font-size: 0.8rem; color: var(--text-muted); line-height: 1.5; }
    
    .calendar-wrapper { background: var(--bg-card); border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 20px; }
    
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .month-year { font-size: 1.2rem; font-weight: 700; color: var(--primary-dark); text-transform: capitalize; }
    .calendar-nav button { background: #f1f2f6; border: 1px solid #e1e1e1; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
    
    /* --- GRID KALENDER --- */
    .calendar-grid-header { display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 10px; }
    .weekday { text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
    
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    
    .day-cell {
      aspect-ratio: 1/1; background: #ffffff; border: 1px solid #eaeaea; border-radius: 10px;
      position: relative; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 6px; overflow: hidden;
    }
    .day-num { font-weight: 600; font-size: 0.95rem; z-index: 2; line-height: 1; }
    
    /* Status Colors */
    .day-cell.has-res { background: #e0f2f1; border-color: var(--primary); }
    .day-cell.has-res .day-num { color: var(--primary-dark); }
    
    .day-cell.is-full { background: var(--danger-light); border: 2px solid var(--danger); opacity: 0.95; }
    .day-cell.is-full::after { 
        content: 'PENUH'; 
        font-size: 0.55rem; 
        color: white; 
        background: var(--danger); 
        font-weight: 800; 
        position: absolute; 
        top: 50%; left: 50%; 
        transform: translate(-50%, -50%) rotate(-20deg); 
        padding: 2px 4px; 
        border-radius: 4px; 
        z-index: 5; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
    }

    /* UPDATED: FIXED TODAY VISIBILITY */
    /* Menggunakan !important untuk memastikan warna hari ini tidak tertimpa status lain */
    .day-cell.today { 
        background: var(--secondary) !important; 
        border: 2px solid #d4ac0d !important; 
        color: white !important; 
        box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
    }
    .day-cell.today .day-num { 
        color: #fff !important; 
        text-shadow: 0 1px 2px rgba(0,0,0,0.4); 
    }
    
    .res-indicator { margin-top: auto; margin-bottom: 6px; display: flex; flex-direction: column; align-items: center; gap: 2px; }
    .res-count { font-size: 0.6rem; color: var(--primary-dark); font-weight: 700; background: rgba(255,255,255,0.7); padding: 1px 4px; border-radius: 4px; }
    
    .legend { display: flex; justify-content: center; gap: 15px; margin-top: 25px; font-size: 0.75rem; color: var(--text-muted); flex-wrap: wrap; border-top: 1px dashed #eee; padding-top: 15px; }
    .dot { width: 12px; height: 12px; border-radius: 4px; display: inline-block; }

    /* --- MODAL DETAIL --- */
    .detail-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(3px); }
    .detail-overlay.active { display: flex; animation: fadeIn 0.3s; }
    
    .detail-sheet { 
        background: #f4f6f8; 
        width: 100%; max-width: 600px; height: 90vh; 
        border-top-left-radius: 25px; border-top-right-radius: 25px; 
        display: flex; flex-direction: column; overflow: hidden; 
        animation: slideUpBig 0.3s ease; 
        box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
    }
    @keyframes slideUpBig { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .sheet-header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; box-shadow: 0 2px 10px rgba(0,0,0,0.03); z-index: 10; flex-shrink: 0; }
    .sheet-content { flex: 1; overflow-y: auto; padding: 25px 20px; -webkit-overflow-scrolling: touch; }
    
    #locGrid { display: flex; flex-direction: column; gap: 25px; padding-bottom: 80px; }

    /* --- KARTU LOKASI --- */
    .loc-card { 
        background: white; 
        border-radius: 20px; 
        overflow: hidden; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
        border: 1px solid white;
        transform: translateZ(0);
        flex-shrink: 0; min-height: auto; 
    }
    
    .loc-header { 
        height: 140px; 
        min-height: 140px; 
        position: relative; 
        background-size: cover; 
        background-position: center; 
        display: flex; 
        align-items: flex-end; 
    }
    
    .loc-title { 
        background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); 
        width: 100%; padding: 15px; color: white; 
        display:flex; justify-content:space-between; align-items: flex-end;
        pointer-events: none; /* Agar klik tembus */
    }
    .loc-name { font-weight: 700; font-size: 1.1rem; text-shadow: 0 2px 4px rgba(0,0,0,0.6); }
    .loc-badge { 
        font-size: 0.75rem; background: rgba(255,255,255,0.25); 
        backdrop-filter: blur(5px); padding: 5px 12px; border-radius: 20px; 
        border: 1px solid rgba(255,255,255,0.4); font-weight: 600;
    }

    /* --- TOMBOL LIHAT FOTO (MATA) --- */
    .btn-view-photo {
        position: absolute;
        top: 15px; right: 15px;
        width: 40px; height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        color: white;
        font-size: 1.1rem;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        z-index: 20;
        transition: transform 0.2s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .btn-view-photo:hover { background: white; color: var(--primary); transform: scale(1.1); }

    /* --- IMAGE VIEWER MODAL (LIGHTBOX) --- */
    .img-modal-overlay {
        position: fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.9); z-index: 3000;
        display: none; align-items: center; justify-content: center;
        flex-direction: column; opacity: 0; transition: opacity 0.3s ease;
    }
    .img-modal-overlay.show { opacity: 1; }
    
    .img-modal-content {
        max-width: 95%; max-height: 80vh;
        border-radius: 8px; box-shadow: 0 5px 30px rgba(0,0,0,0.5);
        transform: scale(0.9); transition: transform 0.3s ease;
    }
    .img-modal-overlay.show .img-modal-content { transform: scale(1); }
    
    .img-caption { color: white; margin-top: 15px; font-weight: 500; font-size: 1.1rem; }
    .close-img-modal {
        position: absolute; top: 20px; right: 20px;
        color: white; font-size: 2rem; cursor: pointer;
        background: rgba(255,255,255,0.2); width: 50px; height: 50px;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
    }

    /* --- CAPACITY BAR --- */
    .capacity-bar-container { width: 100%; height: 6px; background: #eee; position: relative; }
    .capacity-bar-fill { height: 100%; transition: width 0.5s ease-in-out; }
    .bar-green { background: var(--success); } 
    .bar-yellow { background: var(--warning); }
    .bar-red { background: var(--danger); }
    
    /* Tombol */
    .btn-toggle-loc { 
        width: 100%; padding: 15px; background: white; border: none; 
        color: var(--primary); font-weight: 600; cursor: pointer; 
        font-size: 0.9rem; display: flex; align-items: center; justify-content: space-between; 
        transition: background 0.2s;
    }
    .btn-toggle-loc:active { background: #f9f9f9; }
    .btn-toggle-loc.disabled { color: #aaa; cursor: default; }
    
    .loc-body { display: none; background: #fff; padding: 0; border-top: 1px solid #f0f0f0; animation: slideDown 0.3s ease; }
    @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }

    /* Item Reservasi */
    .res-item { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: flex-start; }
    .res-item:last-child { border-bottom: none; }
    .res-info strong { display: block; font-size: 1rem; color: var(--text-main); margin-bottom: 4px; }
    .res-info small { color: #888; font-size: 0.8rem; display: block; }
    
    .menu-detail-text {
        margin-top: 8px; font-size: 0.75rem; color: #555; 
        background: #f8f9fa; padding: 8px 12px; border-radius: 8px; 
        border-left: 3px solid var(--secondary); display: inline-block; width: 100%;
    }
    .res-qty { 
        background: #e0f2f1; color: var(--primary-dark); padding: 6px 12px; 
        border-radius: 10px; font-weight: 700; font-size: 0.9rem; margin-left: 10px;
        min-width: 45px; text-align: center;
    }
    
    /* ADMIN COMPONENTS */
    .floating-admin { position: fixed; bottom: 25px; right: 25px; background: var(--primary-dark); color: white; width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 25px rgba(0,0,0,0.3); z-index: 90; cursor: pointer; }
    .admin-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
    .admin-overlay.show { display: flex; }
    .admin-modal { background: white; padding: 30px; width: 85%; max-width: 350px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: zoomIn 0.2s; }
    @keyframes zoomIn { from {transform: scale(0.9);} to {transform: scale(1);} }
    .btn-block { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .form-input { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 10px; font-family: inherit;}
  </style>
</head>
<body>

  <header>
    <div class="header-branding">
      <h2><i class="fas fa-search-location"></i> Cek Ketersediaan</h2>
      <small>Dolan Sawah Viewer System</small>
    </div>
  </header>

  <div class="main-container">
    
    <div class="info-card">
        <div class="info-icon">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="info-content">
            <h4>Info Reservasi & Reguler</h4>
            <p>Ketersediaan di kalender ini khusus untuk <b>Tempat Reservasi</b>. Pengunjung Reguler (datang langsung) tetap bisa memilih <b>Tempat Reguler</b> yang tersedia di lokasi.</p>
        </div>
    </div>

    <div class="calendar-wrapper">
        <div class="calendar-header">
          <div class="month-year" id="monthYear">Loading...</div>
          <div class="calendar-nav">
            <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
            <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
          </div>
        </div>
    
        <div class="calendar-grid-header">
            <div class="weekday">Min</div><div class="weekday">Sen</div><div class="weekday">Sel</div>
            <div class="weekday">Rab</div><div class="weekday">Kam</div><div class="weekday">Jum</div><div class="weekday">Sab</div>
        </div>
        
        <div class="calendar-days" id="calendar"></div>
        
        <div class="legend">
            <div style="display:flex; gap:5px; align-items:center;"><span class="dot" style="background:var(--secondary); border:1px solid #d4ac0d;"></span> Hari Ini</div>
            <div style="display:flex; gap:5px; align-items:center;"><span class="dot" style="background:var(--primary)"></span> Ada Reservasi</div>
            <div style="display:flex; gap:5px; align-items:center;"><span class="dot" style="background:var(--danger)"></span> Reservasi Penuh</div>
        </div>
    </div>
    
    <div style="margin-top: 25px; text-align: center;">
        <a href="https://www.dolansawah.my.id" style="color: var(--text-muted); font-size: 0.9rem; text-decoration: none; padding: 10px 20px; background: white; border-radius: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: inline-flex; align-items: center; gap: 8px;">
             <i class="fas fa-external-link-alt"></i> Buka Website Utama
        </a>
    </div>
  </div>

  <div class="floating-admin" id="adminBtn"><i class="fas fa-lock"></i></div>

  <div class="detail-overlay" id="detailOverlay">
      <div class="detail-sheet">
          <div class="sheet-header">
              <div><h3 id="sheetDate" style="margin:0; color:var(--primary-dark);">Detail</h3><span id="sheetStats" style="font-size:0.8rem; color:#666;">...</span></div>
              <button onclick="closeDetail()" style="background:#f1f2f6; border:none; width:35px; height:35px; border-radius:50%; font-size:1.2rem; color:#555; cursor:pointer;"><i class="fas fa-times"></i></button>
          </div>
          <div class="sheet-content" id="locGrid"></div>
      </div>
  </div>

  <div class="img-modal-overlay" id="imgModal">
      <span class="close-img-modal" onclick="closeImgModal()">&times;</span>
      <img class="img-modal-content" id="imgTarget">
      <div class="img-caption" id="imgCaption"></div>
  </div>

  <div class="admin-overlay" id="adminOverlay">
      <div class="admin-modal" id="adminModal">
          <h3 style="margin-top:0; text-align:center; color:var(--primary-dark); margin-bottom:20px;"><i class="fas fa-shield-alt"></i> Kontrol Manual</h3>
          <div id="loginForm">
              <input type="email" id="adminEmail" class="form-input" placeholder="Email Admin">
              <input type="password" id="adminPass" class="form-input" placeholder="Password">
              <button class="btn-block" style="background:var(--primary); color:white;" id="btnLoginAction">Masuk</button>
              <button class="btn-block" onclick="closeAdmin()" style="background:#f0f0f0; color:#666;">Batal</button>
          </div>
          <div id="adminControls" style="display:none;">
              <p style="font-size:0.85rem; color:#666; text-align:center; margin-bottom:15px; line-height:1.5;">Tandai tanggal ini sebagai "Reservasi Penuh".</p>
              <input type="date" id="dateSelector" class="form-input">
              <div style="display:flex; gap:10px; margin-bottom:20px;">
                  <button class="btn-block" id="markFullBtn" style="background:var(--danger); color:white; flex:1;"><i class="fas fa-ban"></i> SET PENUH</button>
                  <button class="btn-block" id="markAvailableBtn" style="background:var(--secondary); color:white; flex:1;"><i class="fas fa-check"></i> SET BUKA</button>
              </div>
              <button class="btn-block" onclick="firebase.auth().signOut()" style="background:#f1f2f6; color:#555; margin-top:15px;">Logout</button>
          </div>
      </div>
  </div>

  <script>
    // 1. CONFIG FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyA_c1tU70FM84Qi_f_aSaQ-YVLo_18lCkI",
      authDomain: "reservasi-dolan-sawah.firebaseapp.com",
      projectId: "reservasi-dolan-sawah",
      storageBucket: "reservasi-dolan-sawah.appspot.com",
      messagingSenderId: "213151400721",
      appId: "1:213151400721:web:e51b0d8cdd24206cf682b0"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Data Master Lokasi & Gambar
    const locationImages = {
        "Lantai 1 belakang": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764935931/IMG_7474_ve5qwo.jpg",
        "Gubug 3": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764935931/IMG_7477_bxsmc6.jpg",
        "Lantai 2": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764935931/IMG_7475_s9rtpo.jpg",
        "Lantai 1 depan": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764935935/IMG_7472_gd2zsf.jpg",
        "Pondok 2": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764936109/3ac34945-6aef-4921-8c08-f9cbf8ab4892_mfdft0.jpg",
        "Pondok 3": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764936110/49d5f9c2-da86-461e-bdca-ad04398bfd99_yturyb.jpg",
        "Pondok 1": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764936110/ae454394-906a-43d6-a3e7-7453e5ef91b7_fdzogh.jpg",
        "Lantai 3": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764935931/IMG_7479_dlgxmv.jpg",
        "Lantai 1 tengah": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764985452/IMG_7494_wyskxg.jpg",
        "Meeting Room": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764985551/IMG_7491_shjtqx.jpg",
        "Lantai 1 Full Blok": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764985614/image_e2za88.jpg"
    };
    const defaultImage = "https://via.placeholder.com/300x200?text=Lokasi";
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let allReservations = {}; 
    let locationsConfig = {};
    let dateStatus = {};
    let unsubscribeRes = null;
    let unsubscribeStatus = null;

    document.addEventListener('DOMContentLoaded', async () => {
        await loadLocations();
        setupRealtimeListeners();
        setupAdminLogic();
        
        document.getElementById('prevMonth').addEventListener('click', () => { currentMonth--; if(currentMonth < 0) { currentMonth=11; currentYear--; } setupRealtimeListeners(); });
        document.getElementById('nextMonth').addEventListener('click', () => { currentMonth++; if(currentMonth > 11) { currentMonth=0; currentYear++; } setupRealtimeListeners(); });
    });

    async function loadLocations() {
        try {
            const snap = await db.collection("locations").get();
            snap.forEach(doc => locationsConfig[doc.data().name] = doc.data().capacity);
        } catch(e) { console.log("Gagal load lokasi", e); }
    }

    function setupRealtimeListeners() {
        if(unsubscribeRes) unsubscribeRes();
        if(unsubscribeStatus) unsubscribeStatus();

        const mStr = String(currentMonth + 1).padStart(2, '0');
        const start = `${currentYear}-${mStr}-01`;
        const end = `${currentYear}-${mStr}-31`;

        document.getElementById('calendar').innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px; color:#999;">Memuat Data...</div>';
        document.getElementById('monthYear').textContent = `${monthNames[currentMonth]} ${currentYear}`;

        unsubscribeRes = db.collection("reservations")
            .where('date', '>=', start).where('date', '<=', end)
            .onSnapshot(snapshot => {
                allReservations = {};
                snapshot.forEach(doc => {
                    const r = doc.data();
                    if(!allReservations[r.date]) allReservations[r.date] = [];
                    allReservations[r.date].push(r);
                });
                renderCalendar();
            });
            
        unsubscribeStatus = db.collection("date_status")
             .where('date', '>=', start).where('date', '<=', end)
             .onSnapshot(snapshot => {
                 dateStatus = {};
                 snapshot.forEach(doc => {
                     dateStatus[doc.data().date] = doc.data().isFull;
                 });
                 renderCalendar();
             });
    }

    function renderCalendar() {
        const cal = document.getElementById('calendar');
        cal.innerHTML = '';
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const today = new Date();

        for(let i=0; i<firstDay; i++) cal.innerHTML += `<div></div>`;

        for(let i=1; i<=daysInMonth; i++) {
            const el = document.createElement('div');
            el.className = 'day-cell';
            const mStr = String(currentMonth + 1).padStart(2, '0');
            const dStr = String(i).padStart(2, '0');
            const dateKey = `${currentYear}-${mStr}-${dStr}`;
            const list = allReservations[dateKey] || [];
            const count = list.length;
            const total = list.reduce((s,r) => s + (parseInt(r.jumlah)||0), 0);
            const isManualFull = dateStatus[dateKey] === true;

            // Logika Prioritas Tampilan
            // 1. Cek apakah ini hari ini
            if(i === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                el.classList.add('today');
            }
            
            // 2. Cek apakah penuh manual
            if(isManualFull) {
                el.classList.add('is-full');
            } 
            // 3. Cek apakah ada reservasi (jika tidak penuh manual)
            else if(count > 0) {
                el.classList.add('has-res');
                el.innerHTML = `<span class="day-num">${i}</span><div class="res-indicator"><div class="res-count">${total}</div></div>`;
            } 
            // 4. Kosong
            else {
                el.innerHTML = `<span class="day-num">${i}</span>`;
            }

            el.onclick = () => openDetail(i, list);
            cal.appendChild(el);
        }
    }

    // --- LOGIKA DETAIL ---
    function openDetail(day, list) {
        document.getElementById('detailOverlay').classList.add('active');
        document.getElementById('sheetDate').textContent = `${day} ${monthNames[currentMonth]} ${currentYear}`;
        
        const totalGuests = list.reduce((s,r) => s + (parseInt(r.jumlah)||0), 0);
        document.getElementById('sheetStats').textContent = `${list.length} Grup / ${totalGuests} Tamu Total`;
        
        const grid = document.getElementById('locGrid');
        grid.innerHTML = '';

        const grouped = {};
        list.forEach(r => {
            let l = r.tempat || 'Lainnya';
            if (l.toLowerCase() === 'meeting room') l = 'Meeting Room';
            if(!grouped[l]) grouped[l] = [];
            grouped[l].push(r);
        });

        const allLocations = Object.keys(locationImages).sort();
        
        allLocations.forEach(loc => {
            const items = grouped[loc] || [];
            const img = locationImages[loc] || defaultImage;
            const cap = locationsConfig[loc] || 100;
            const curr = items.reduce((s,r)=>s+(parseInt(r.jumlah)||0),0);
            
            let percent = cap > 0 ? (curr / cap) * 100 : 0;
            if(percent > 100) percent = 100;
            let barColor = 'bar-green';
            if (percent >= 90) barColor = 'bar-red';
            else if (percent >= 50) barColor = 'bar-yellow';

            let htmlItems = '';
            if(items.length > 0) {
                items.sort((a,b)=> (a.jam||'').localeCompare(b.jam||'')).forEach(r => {
                    let menuText = '';
                    if(r.menus && Array.isArray(r.menus) && r.menus.length > 0) {
                        menuText = `<div class="menu-detail-text">${r.menus.map(m => m.quantity + 'x ' + m.name).join('<br>')}</div>`;
                    } else if (r.menu) {
                        menuText = `<div class="menu-detail-text">${r.menu}</div>`;
                    }

                    const safePhone = r.nomorHp && r.nomorHp.length > 4 ? r.nomorHp.slice(0, -3) + 'xxx' : (r.nomorHp || '');

                    htmlItems += `
                        <div class="res-item">
                            <div class="res-info">
                                <strong>${r.nama}</strong>
                                <small>
                                    <i class="far fa-clock"></i> ${r.jam} WIB 
                                    ${safePhone ? ' â€¢ <i class="fab fa-whatsapp"></i> ' + safePhone : ''}
                                </small>
                                ${menuText}
                                ${r.tambahan ? `<div style="color:var(--highlight); font-size:0.75rem; margin-top:3px; font-style:italic;">Note: ${r.tambahan}</div>` : ''}
                            </div>
                            <div class="res-qty">${r.jumlah}</div>
                        </div>`;
                });
            } else {
                htmlItems = `<div style="padding:20px; text-align:center; color:#aaa; font-size:0.85rem;">Belum ada reservasi. Tempat ini kosong.</div>`;
            }

            const btnText = items.length > 0 ? `Lihat ${items.length} Reservasi` : 'Masih Kosong';
            const btnClass = items.length > 0 ? '' : 'disabled';
            const onclickAttr = items.length > 0 ? 'onclick="toggleAccordion(this)"' : '';
            const iconHtml = items.length > 0 ? '<i class="fas fa-chevron-down"></i>' : '<i class="fas fa-check-circle" style="color:var(--success);"></i>';

            const card = document.createElement('div');
            card.className = 'loc-card';
            card.innerHTML = `
                <div class="loc-header" style="background-image:url('${img}')">
                    <button class="btn-view-photo" onclick="viewPhoto('${img}', '${loc}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <div class="loc-title">
                        <span class="loc-name">${loc}</span>
                        <span class="loc-badge">${curr} / ${cap} Org</span>
                    </div>
                </div>
                
                <div class="capacity-bar-container">
                    <div class="capacity-bar-fill ${barColor}" style="width: ${percent}%;"></div>
                </div>
                
                <button class="btn-toggle-loc ${btnClass}" ${onclickAttr}>
                    <span>${btnText}</span>
                    ${iconHtml}
                </button>
                
                <div class="loc-body">
                    ${htmlItems}
                </div>
            `;
            grid.appendChild(card);
        });
    }

    // --- FOTO VIEWER ---
    function viewPhoto(url, caption) {
        const modal = document.getElementById('imgModal');
        const img = document.getElementById('imgTarget');
        const txt = document.getElementById('imgCaption');
        
        img.src = url;
        txt.textContent = caption;
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeImgModal() {
        const modal = document.getElementById('imgModal');
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // Tutup jika klik diluar gambar
    document.getElementById('imgModal').addEventListener('click', (e) => {
        if(e.target.id === 'imgModal') closeImgModal();
    });

    // Accordion
    window.toggleAccordion = function(btn) {
        const body = btn.nextElementSibling;
        const icon = btn.querySelector('.fa-chevron-down, .fa-chevron-up');
        
        if(body.style.display === 'block') {
            body.style.display = 'none';
            if(icon) icon.className = 'fas fa-chevron-down';
            btn.style.background = 'white';
        } else {
            body.style.display = 'block';
            if(icon) icon.className = 'fas fa-chevron-up';
            btn.style.background = '#f9f9f9';
        }
    }
    
    function closeDetail() { document.getElementById('detailOverlay').classList.remove('active'); }
    
    // ADMIN LOGIC
    function setupAdminLogic() {
        const btn = document.getElementById('adminBtn');
        const overlay = document.getElementById('adminOverlay');
        const modal = document.getElementById('adminModal');
        
        const open = () => { overlay.classList.add('show'); modal.classList.add('show'); };
        window.closeAdmin = () => { overlay.classList.remove('show'); modal.classList.remove('show'); };
        
        btn.onclick = open;
        overlay.onclick = (e) => { if(e.target === overlay) window.closeAdmin(); };
        
        auth.onAuthStateChanged(user => {
            document.getElementById('loginForm').style.display = user ? 'none' : 'block';
            document.getElementById('adminControls').style.display = user ? 'block' : 'none';
        });

        document.getElementById('btnLoginAction').onclick = () => {
            const e = document.getElementById('adminEmail').value;
            const p = document.getElementById('adminPass').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => alert("Login Gagal: " + err.message));
        };

        const updateStatus = async (isFull) => {
            const d = document.getElementById('dateSelector').value;
            if(!d) return alert("Pilih tanggal dulu");
            try {
                await db.collection("date_status").doc(d).set({
                    date: d,
                    isFull: isFull
                }, { merge: true });
                alert("Status Berhasil Diupdate!");
            } catch(e) { alert("Error: " + e.message); }
        };

        document.getElementById('markFullBtn').onclick = () => updateStatus(true);
        document.getElementById('markAvailableBtn').onclick = () => updateStatus(false);
    }
  </script>
</body>
</html>
