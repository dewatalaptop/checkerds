<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>Dashboard Reservasi Dolan Sawah</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <style>
    :root {
      /* Palette Resmi */
      --primary: #2a9d8f; 
      --primary-dark: #203a43;
      --secondary: #e9c46a;
      --accent: #f4a261;
      --danger: #e76f51;
      --bg-body: #f0f2f5;
      --bg-card: #ffffff;
      --text-main: #2d3436;
      --text-muted: #636e72;
      --shadow-soft: 0 10px 30px -10px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background-color: var(--bg-body);
      color: var(--text-main);
      padding-bottom: 80px; /* Space untuk floating button */
      overflow-x: hidden;
    }

    /* --- HEADER (Updated) --- */
    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      padding: 20px 25px 40px;
      color: white;
      border-bottom-left-radius: 30px;
      border-bottom-right-radius: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      position: relative; z-index: 10;
    }
    .header-branding { cursor: pointer; } /* Bisa diklik untuk login admin */
    .header-branding h2 { margin: 0; font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .header-branding small { opacity: 0.8; font-size: 0.8rem; display: block; margin-top: 5px; }

    /* --- CONTAINER UTAMA --- */
    .main-container { max-width: 1000px; margin: -30px auto 0; padding: 0 15px; position: relative; z-index: 20; }
    
    .calendar-wrapper {
      background: var(--bg-card);
      border-radius: 20px;
      box-shadow: var(--shadow-soft);
      padding: 25px;
      animation: slideUp 0.5s ease;
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* --- KALENDER KONTROL --- */
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .month-year { font-size: 1.3rem; font-weight: 700; color: var(--primary-dark); }
    
    .calendar-nav button {
      background: var(--bg-body); border: none; width: 38px; height: 38px; border-radius: 50%;
      color: var(--text-main); cursor: pointer; margin-left: 5px; transition: 0.2s;
      display: flex; align-items: center; justify-content: center;
    }
    .calendar-nav button:hover { background: var(--primary); color: white; transform: scale(1.1); }

    /* --- GRID KALENDER --- */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
    .weekday { text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }

    .day-cell {
      aspect-ratio: 1/1; background: #fff; border: 1px solid #f0f0f0; border-radius: 14px;
      position: relative; cursor: pointer; display: flex; flex-direction: column;
      align-items: center; justify-content: center; transition: all 0.2s;
    }
    .day-cell:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); z-index: 2; }
    
    .day-num { font-weight: 600; font-size: 1rem; z-index: 2; }
    
    /* Status Warna Tanggal */
    .day-cell.today { background: var(--secondary); border-color: var(--secondary); color: white; box-shadow: 0 4px 10px rgba(233, 196, 106, 0.4); }
    .day-cell.today .day-num { color: white; }
    
    .day-cell.has-res { background: #e0f2f1; border-color: var(--primary); }
    .day-cell.has-res .day-num { color: var(--primary-dark); }
    
    /* Indikator Tamu Kecil */
    .res-indicator { 
        margin-top: 4px; display: flex; align-items: center; gap: 3px; 
        background: rgba(255,255,255,0.6); padding: 2px 6px; border-radius: 10px;
    }
    .res-dot { width: 6px; height: 6px; background: var(--primary); border-radius: 50%; }
    .res-count { font-size: 0.65rem; color: var(--primary-dark); font-weight: 700; }
    
    .day-cell.is-full { background: #ffebee; border-color: var(--danger); }
    .day-cell.is-full::after { 
        content: 'PENUH'; font-size: 0.55rem; color: var(--danger); 
        font-weight: 800; position: absolute; bottom: 6px; letter-spacing: 0.5px;
    }

    /* Legenda */
    .legend { display: flex; justify-content: center; gap: 20px; margin-top: 25px; font-size: 0.8rem; color: var(--text-muted); flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

    /* --- INFO MODAL (Yang Sempat Hilang) --- */
    .info-modal-overlay {
        position: fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(32, 58, 67, 0.6); backdrop-filter: blur(4px);
        z-index: 3000; display: flex; align-items: center; justify-content: center;
        visibility: hidden; opacity: 0; transition: 0.3s;
    }
    .info-modal-overlay.show { visibility: visible; opacity: 1; }
    .info-card {
        background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 350px;
        text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); transform: scale(0.9); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .info-modal-overlay.show .info-card { transform: scale(1); }

    /* --- DETAIL SHEET (MODERN BOTTOM SHEET) --- */
    .detail-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); z-index: 1000; display: none;
      align-items: flex-end; justify-content: center; backdrop-filter: blur(3px);
    }
    .detail-overlay.active { display: flex; animation: fadeIn 0.3s; }
    
    .detail-sheet {
      background: var(--bg-body); width: 100%; max-width: 600px; height: 85vh;
      border-top-left-radius: 25px; border-top-right-radius: 25px;
      display: flex; flex-direction: column; overflow: hidden;
      box-shadow: 0 -10px 40px rgba(0,0,0,0.2); animation: slideUpBig 0.3s ease;
    }
    @keyframes slideUpBig { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .sheet-header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
    .sheet-title h3 { margin: 0; font-size: 1.1rem; color: var(--primary-dark); }
    .sheet-title span { font-size: 0.8rem; color: var(--text-muted); display: block; margin-top: 2px;}
    .close-sheet { background: #f1f2f6; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 1.1rem; cursor: pointer; color: #555; transition: 0.2s; }
    .close-sheet:hover { background: var(--danger); color: white; }

    .sheet-content { flex: 1; overflow-y: auto; padding: 20px; }
    
    /* --- KARTU LOKASI --- */
    .loc-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
    .loc-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid #f0f0f0; }
    
    .loc-header { height: 110px; position: relative; background-size: cover; background-position: center; display: flex; align-items: flex-end; }
    .loc-header::before { content: ''; position: absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); }
    .loc-title { position: relative; z-index: 2; padding: 12px 15px; width: 100%; color: white; display: flex; justify-content: space-between; align-items: flex-end; }
    .loc-name { font-weight: 700; font-size: 1rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .loc-capacity-badge { font-size: 0.75rem; background: rgba(255,255,255,0.25); padding: 4px 10px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.4); backdrop-filter: blur(4px); font-weight: 600; }

    .progress-container { height: 6px; background: #eee; width: 100%; }
    .progress-bar { height: 100%; background: var(--primary); transition: width 0.3s; }
    .progress-bar.warning { background: var(--accent); }
    .progress-bar.danger { background: var(--danger); }

    .res-item { padding: 15px; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; align-items: flex-start; background: white; }
    .res-info { display: flex; gap: 12px; align-items: flex-start; }
    .res-avatar { width: 35px; height: 35px; background: var(--primary-light); color: var(--primary); border-radius: 50%; font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .res-details strong { display: block; font-size: 0.95rem; color: var(--text-main); margin-bottom: 2px; }
    .res-details span { font-size: 0.8rem; color: var(--text-muted); display: block; }
    .menu-tags { margin-top:6px; display: flex; flex-wrap: wrap; gap: 4px;}
    .menu-tag { font-size:0.7rem; background:#f8f9fa; padding:3px 8px; border-radius:4px; border: 1px solid #eee; color: #555; }

    .btn-toggle-loc { width: 100%; padding: 12px; background: white; border: none; color: var(--primary); font-weight: 600; font-size: 0.85rem; cursor: pointer; border-top: 1px solid #f0f0f0; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .loc-body { display: none; background: #fafafa; border-top: 1px solid #f0f0f0; }

    /* --- ADMIN PANEL --- */
    .floating-admin { position: fixed; bottom: 25px; right: 25px; background: var(--primary-dark); color: white; width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 25px rgba(0,0,0,0.25); z-index: 90; cursor: pointer; transition: 0.2s; }
    .floating-admin:active { transform: scale(0.95); }
    
    .admin-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; width: 90%; max-width: 400px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 2000; display: none; }
    .admin-modal.show { display: block; }
    .admin-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1999; display:none; }
    .admin-overlay.show { display: block; }

    .form-input { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-family: inherit; }
    .btn-block { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-bottom: 10px; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px;}
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    
    @media (min-width: 768px) {
        .detail-sheet { height: 85vh; max-height: 800px; border-radius: 20px; margin-bottom: 30px; }
        .detail-overlay { align-items: center; padding: 20px; }
        .loc-grid { grid-template-columns: 1fr 1fr; }
        .calendar-wrapper { padding: 30px; }
    }
  </style>

</head>
<body>

  <header>
    <div class="header-branding" id="headerAdminTrigger">
      <h2><i class="fas fa-calendar-alt"></i> Dolan Sawah</h2>
      <small>Sistem Monitoring & Reservasi</small>
    </div>
  </header>

  <div class="main-container">
    <div class="calendar-wrapper">
        <div class="calendar-header">
          <div class="month-year" id="monthYear">...</div>
          <div class="calendar-nav">
            <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
            <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
          </div>
        </div>
    
        <div class="calendar-grid">
            <div class="weekday">Min</div><div class="weekday">Sen</div><div class="weekday">Sel</div>
            <div class="weekday">Rab</div><div class="weekday">Kam</div><div class="weekday">Jum</div><div class="weekday">Sab</div>
        </div>
        <div class="calendar-grid" id="calendar" style="margin-top: 10px;"></div>
        
        <div class="legend">
            <div class="legend-item"><span class="dot" style="background:var(--secondary)"></span> Hari Ini</div>
            <div class="legend-item"><span class="dot" style="background:var(--primary)"></span> Ada Reservasi</div>
            <div class="legend-item"><span class="dot" style="background:var(--danger)"></span> Penuh</div>
        </div>
    </div>
    
    <div style="margin-top: 25px; text-align: center;">
        <a href="https://www.dolansawah.my.id" style="display:inline-flex; align-items:center; gap:8px; color: var(--text-muted); text-decoration: none; font-size: 0.9rem; font-weight: 500; padding: 10px 20px; background: white; border-radius: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
            <i class="fas fa-external-link-alt"></i> Kembali ke Web Utama
        </a>
    </div>
  </div>

  <div class="floating-admin" id="adminBtn"><i class="fas fa-user-shield"></i></div>

  <div class="info-modal-overlay" id="infoModal">
      <div class="info-card">
          <div style="font-size: 3.5rem; color: var(--secondary); margin-bottom: 15px;"><i class="fas fa-info-circle"></i></div>
          <h3 style="margin:0 0 10px; color:var(--primary-dark);">Panduan Viewer</h3>
          <p style="color:var(--text-muted); line-height:1.6; font-size:0.9rem;">Klik pada tanggal di kalender untuk melihat detail tamu dan status per lokasi.</p>
          <button class="btn-block btn-primary" onclick="closeInfoModal()" style="margin-top:20px;">Mengerti</button>
      </div>
  </div>

  <div class="detail-overlay" id="detailOverlay">
      <div class="detail-sheet">
          <div class="sheet-header">
              <div class="sheet-title">
                  <h3 id="sheetDate">Detail Tanggal</h3>
                  <span id="sheetStats">Loading...</span>
              </div>
              <button class="close-sheet" onclick="closeDetail()"><i class="fas fa-times"></i></button>
          </div>
          <div class="sheet-content">
              <div class="loc-grid" id="locGrid"></div>
          </div>
      </div>
  </div>

  <div class="admin-overlay" id="adminOverlay"></div>
  <div class="admin-modal" id="adminModal">
      <h3 style="margin-top:0; color:var(--primary-dark); text-align:center;"><i class="fas fa-lock"></i> Admin Access</h3>
      
      <div id="loginForm">
          <input type="email" id="adminEmail" class="form-input" placeholder="Email Admin">
          <input type="password" id="adminPass" class="form-input" placeholder="Password">
          <button class="btn-block btn-primary" id="btnLoginAction">Masuk</button>
          <button class="btn-block btn-danger" onclick="closeAdmin()" style="background:transparent; color:#888; border:1px solid #ddd;">Batal</button>
          <p id="loginError" style="color:var(--danger); font-size:0.8rem; display:none; text-align:center;">Login Gagal.</p>
      </div>

      <div id="adminControls" style="display:none;">
          <label style="font-size:0.85rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Atur Status Tanggal:</label>
          <input type="date" id="dateSelector" class="form-input">
          <div style="display:flex; gap:8px; margin-bottom:20px;">
              <button class="btn-block btn-danger" id="markFullBtn" style="flex:1;"><i class="fas fa-ban"></i> Set PENUH</button>
              <button class="btn-block btn-primary" id="markAvailableBtn" style="flex:1; background:var(--secondary);"><i class="fas fa-check"></i> Set BUKA</button>
          </div>
          
          <div style="border-top:1px dashed #ddd; padding-top:15px; margin-top:10px;">
             <label style="font-size:0.85rem; color:#666; display:block; margin-bottom:5px; font-weight:600;">Import Data (Reset):</label>
             <textarea id="dataImportCode" class="form-input" rows="3" placeholder="Tempel kode JSON di sini..."></textarea>
             <button class="btn-block btn-primary" id="importBtn"><i class="fas fa-file-import"></i> Proses Import</button>
          </div>
          
          <button class="btn-block btn-danger" onclick="firebase.auth().signOut()" style="margin-top:20px;"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
  </div>

  <script>
    // --- 1. KONFIGURASI FIREBASE (JANGAN DIUBAH) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCFcS_2tOXDg78yNAVVP9LMHoUVe91jtsY",
      authDomain: "reservasi-viewer-dolan-sawah.firebaseapp.com",
      projectId: "reservasi-viewer-dolan-sawah",
      storageBucket: "reservasi-viewer-dolan-sawah.firebasestorage.app",
      messagingSenderId: "932937427518",
      appId: "1:932937427518:web:806e241519b718cc21ff6f"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- 2. DATA FOTO LOKASI (Dari Web Mandiri) ---
    const locationImages = {
        "Lantai 1 belakang": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764935931/IMG_7474_ve5qwo.jpg",
        "Gubug 3": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764935931/IMG_7477_bxsmc6.jpg",
        "Lantai 2": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764935931/IMG_7475_s9rtpo.jpg",
        "Lantai 1 depan": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764935935/IMG_7472_gd2zsf.jpg",
        "Pondok 2": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764936109/3ac34945-6aef-4921-8c08-f9cbf8ab4892_mfdft0.jpg",
        "Pondok 3": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764936110/49d5f9c2-da86-461e-bdca-ad04398bfd99_yturyb.jpg",
        "Pondok 1": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764936110/ae454394-906a-43d6-a3e7-7453e5ef91b7_fdzogh.jpg",
        "Lantai 3": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764935931/IMG_7479_dlgxmv.jpg",
        "Lantai 1 tengah": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764985452/IMG_7494_wyskxg.jpg",
        "Meeting room": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764985551/IMG_7491_shjtqx.jpg",
        "Meeting Room": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764985551/IMG_7491_shjtqx.jpg",
        "Lantai 1 Full Blok": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764985614/image_e2za88.jpg"
    };
    const defaultImage = "https://via.placeholder.com/300x200?text=Lokasi+Dolan+Sawah";

    // Global Vars
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let allReservations = {};
    let locationsConfig = {};

    document.addEventListener('DOMContentLoaded', async () => {
        // Tampilkan Info Modal
        setTimeout(() => document.getElementById('infoModal').classList.add('show'), 500);
        
        await loadConfig();
        
        // Listener Realtime
        db.collection("reservations").onSnapshot(snapshot => {
            allReservations = {};
            snapshot.forEach(doc => allReservations[doc.id] = doc.data());
            renderCalendar();
        });

        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonth--; if(currentMonth < 0) { currentMonth=11; currentYear--; } renderCalendar();
        });
        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonth++; if(currentMonth > 11) { currentMonth=0; currentYear++; } renderCalendar();
        });

        setupAdminUI();
    });

    function closeInfoModal() { document.getElementById('infoModal').classList.remove('show'); }

    async function loadConfig() {
        try {
            const doc = await db.collection("config").doc("locations").get();
            if(doc.exists) locationsConfig = doc.data();
        } catch(e) { console.error("Error loading config", e); }
    }

    function renderCalendar() {
        const cal = document.getElementById('calendar');
        const title = document.getElementById('monthYear');
        cal.innerHTML = '';
        title.textContent = `${monthNames[currentMonth]} ${currentYear}`;

        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const today = new Date();

        // Slot kosong awal bulan
        for(let i=0; i<firstDay; i++) cal.innerHTML += `<div></div>`;

        // Generate Hari
        for(let i=1; i<=daysInMonth; i++) {
            const el = document.createElement('div');
            el.className = 'day-cell';
            
            const monthStr = String(currentMonth + 1).padStart(2, '0');
            const dayStr = String(i).padStart(2, '0');
            const key = `${monthStr}-${dayStr}`;
            const data = allReservations[key];
            const count = data?.reservations?.length || 0;

            if(i === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                el.classList.add('today');
            }
            if(data?.isFull) el.classList.add('is-full');
            
            // Tampilan Angka & Indikator
            let content = `<span class="day-num">${i}</span>`;
            
            if(count > 0) {
                el.classList.add('has-res');
                const totalG = data.reservations.reduce((sum, r) => sum + (parseInt(r.jumlah)||0), 0);
                content += `
                    <div class="res-indicator">
                        <div class="res-dot"></div>
                        <span class="res-count">${totalG}</span>
                    </div>`;
            }
            el.innerHTML = content;
            el.onclick = () => openDetail(i, data);
            cal.appendChild(el);
        }
    }

    // --- 3. DETAIL VIEW LOGIC (GENERATOR KARTU LOKASI) ---
    function openDetail(day, data) {
        const overlay = document.getElementById('detailOverlay');
        const title = document.getElementById('sheetDate');
        const stats = document.getElementById('sheetStats');
        const grid = document.getElementById('locGrid');
        
        const fullDate = `${day} ${monthNames[currentMonth]} ${currentYear}`;
        title.textContent = fullDate;
        
        const resList = data?.reservations || [];
        const totalGuests = resList.reduce((acc, curr) => acc + (parseInt(curr.jumlah)||0), 0);
        stats.textContent = `${totalGuests} Tamu Total / ${resList.length} Grup Reservasi`;

        // Grouping Data
        const grouped = {};
        Object.keys(locationsConfig).forEach(loc => grouped[loc] = []);
        resList.forEach(r => {
            const loc = r.tempat || 'Belum Ditentukan';
            if(!grouped[loc]) grouped[loc] = [];
            grouped[loc].push(r);
        });

        grid.innerHTML = '';
        
        // Sorting: Lokasi ada isi -> Abjad
        const sortedLocs = Object.keys(grouped).sort((a,b) => {
            const lenA = grouped[a].length; const lenB = grouped[b].length;
            if(lenA !== lenB) return lenB - lenA;
            return a.localeCompare(b);
        });

        sortedLocs.forEach(locName => {
            const items = grouped[locName];
            const maxCap = locationsConfig[locName] || 0;
            const currentTotal = items.reduce((s, r) => s + (parseInt(r.jumlah)||0), 0);
            
            // Logic Progress Bar Warna
            let percent = maxCap > 0 ? (currentTotal / maxCap) * 100 : 0;
            if(percent > 100) percent = 100;
            let barClass = 'progress-bar';
            if(percent > 80) barClass += ' warning';
            if(percent >= 100) barClass += ' danger';

            const bgImg = locationImages[locName] || defaultImage;
            
            // Generate List HTML
            let listHtml = '';
            if(items.length > 0) {
                items.sort((a,b) => a.jam.localeCompare(b.jam)).forEach(r => {
                   let menuHtml = '';
                   // Logic Menu (Ringkas)
                   if(r.menus && r.menus.length > 0) {
                       menuHtml = `<div class="menu-tags">`;
                       r.menus.forEach(m => menuHtml += `<span class="menu-tag">${m.quantity}x ${m.name}</span>`);
                       menuHtml += `</div>`;
                   }
                   
                   listHtml += `
                     <div class="res-item">
                        <div class="res-info">
                            <div class="res-avatar">${r.nama ? r.nama.charAt(0).toUpperCase() : '?'}</div>
                            <div class="res-details">
                                <strong>${r.nama}</strong>
                                <span><i class="far fa-clock"></i> ${r.jam} WIB ${r.nomorHp ? ' | ' + r.nomorHp : ''}</span>
                                ${menuHtml}
                            </div>
                        </div>
                        <span style="font-weight:700; color:var(--primary); font-size:0.9rem;">${r.jumlah} Org</span>
                     </div>
                   `; 
                });
            } else {
                listHtml = `<div style="padding:20px; text-align:center; color:#aaa; font-size:0.85rem; font-style:italic;">Belum ada reservasi di area ini.</div>`;
            }

            const card = document.createElement('div');
            card.className = 'loc-card';
            card.innerHTML = `
                <div class="loc-header" style="background-image: url('${bgImg}');">
                    <div class="loc-title">
                        <span class="loc-name">${locName}</span>
                        <span class="loc-capacity-badge">${currentTotal} / ${maxCap || '-'}</span>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="${barClass}" style="width: ${percent}%;"></div>
                </div>
                <button class="btn-toggle-loc" onclick="toggleLoc(this)">
                    ${items.length > 0 ? `Lihat ${items.length} Reservasi` : 'Area Kosong'} 
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="loc-body">${listHtml}</div>
            `;
            grid.appendChild(card);
        });

        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeDetail() {
        document.getElementById('detailOverlay').classList.remove('active');
        document.body.style.overflow = '';
    }
    
    // Fungsi Accordion
    window.toggleLoc = function(btn) {
        const body = btn.nextElementSibling;
        const icon = btn.querySelector('i');
        if(body.style.display === 'block') {
            body.style.display = 'none'; icon.className = 'fas fa-chevron-down';
        } else {
            body.style.display = 'block'; icon.className = 'fas fa-chevron-up';
        }
    }

    // --- 4. SYSTEM ADMIN (AMAN & LENGKAP) ---
    function setupAdminUI() {
        const floatBtn = document.getElementById('adminBtn');
        const headerTrigger = document.getElementById('headerAdminTrigger'); // Support klik header
        const modal = document.getElementById('adminModal');
        const overlay = document.getElementById('adminOverlay');
        const form = document.getElementById('loginForm');
        const controls = document.getElementById('adminControls');
        const err = document.getElementById('loginError');
        
        const open = () => { overlay.classList.add('show'); modal.classList.add('show'); };
        window.closeAdmin = () => { overlay.classList.remove('show'); modal.classList.remove('show'); err.style.display='none'; };
        
        floatBtn.onclick = open;
        headerTrigger.onclick = open;
        overlay.onclick = window.closeAdmin;
        
        // Cek Status Login
        auth.onAuthStateChanged(user => {
            if(user) {
                form.style.display = 'none';
                controls.style.display = 'block';
            } else {
                form.style.display = 'block';
                controls.style.display = 'none';
            }
        });

        // ACTION: Login
        document.getElementById('btnLoginAction').onclick = () => {
            const email = document.getElementById('adminEmail').value;
            const pass = document.getElementById('adminPass').value;
            if(!email || !pass) { err.style.display = 'block'; err.textContent="Mohon isi Email & Password"; return; }
            
            const btn = document.getElementById('btnLoginAction');
            btn.textContent = "Memproses..."; btn.disabled = true;
            
            auth.signInWithEmailAndPassword(email, pass)
                .catch(e => { err.style.display='block'; err.textContent = "Password Salah / User tidak ditemukan."; })
                .finally(() => { btn.textContent = "Masuk"; btn.disabled = false; });
        };

        // ACTION: Update Tanggal
        const updateStatus = async (status) => {
            const dateVal = document.getElementById('dateSelector').value;
            if(!dateVal) return alert("Pilih tanggal kalender terlebih dahulu.");
            const [y, m, d] = dateVal.split('-');
            try {
                await db.collection("reservations").doc(`${m}-${d}`).set({ isFull: status }, { merge: true });
                alert("Status Tanggal Berhasil Diupdate!");
            } catch(e) { alert("Error: " + e.message); }
        };
        document.getElementById('markFullBtn').onclick = () => updateStatus(true);
        document.getElementById('markAvailableBtn').onclick = () => updateStatus(false);

        // ACTION: Import Data (DENGAN PEMBERSIHAN DATA LAMA)
        document.getElementById('importBtn').onclick = async () => {
            const code = document.getElementById('dataImportCode').value;
            if(!code) return alert("Kode JSON kosong.");
            if(!confirm("PERINGATAN KERAS:\nSemua data reservasi lama akan DIHAPUS dan diganti data baru dari JSON.\n\nLanjutkan?")) return;
            
            const btn = document.getElementById('importBtn');
            btn.disabled = true; btn.textContent = "Menghapus Data Lama...";

            try {
                const json = JSON.parse(decodeURIComponent(escape(atob(code))));
                
                // 1. Update Config Kapasitas
                if(json.locations) {
                    const map = {};
                    for(let k in json.locations) map[json.locations[k].name] = json.locations[k].capacity;
                    await db.collection("config").doc("locations").set(map);
                }

                // 2. HAPUS SEMUA DATA LAMA (Batch Delete)
                const oldDocs = await db.collection('reservations').get();
                const BATCH_SIZE = 400;
                let deleteBatch = db.batch(); let deleteCount = 0;
                oldDocs.forEach(doc => {
                    deleteBatch.delete(doc.ref);
                    deleteCount++;
                });
                if(deleteCount > 0) await deleteBatch.commit();

                // 3. UPLOAD DATA BARU (Batch Set)
                btn.textContent = "Mengupload Data Baru...";
                if(json.data) {
                    let addBatch = db.batch(); let addCount = 0;
                    for(let dateKey in json.data) {
                        const docRef = db.collection("reservations").doc(dateKey);
                        // Penting: Set isFull default false agar tidak error
                        addBatch.set(docRef, { reservations: json.data[dateKey], isFull: false });
                        addCount++;
                        if(addCount === BATCH_SIZE) { await addBatch.commit(); addBatch = db.batch(); addCount = 0; }
                    }
                    if(addCount > 0) await addBatch.commit();
                }

                alert("SUKSES! Data reservasi telah diperbarui.");
                document.getElementById('dataImportCode').value = '';
                window.closeAdmin();
            } catch(e) { 
                alert("GAGAL IMPORT: " + e.message); 
            } finally {
                btn.disabled = false; btn.textContent = "Proses Import";
            }
        }
    }
  </script>
</body>
</html>
