<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Member VIP Restoran</title>
    <!-- Gunakan versi stabil dari library -->
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/dist/html5-qrcode.min.js"></script>
    <style>
        /* [CSS Anda yang sebelumnya tetap sama] */
    </style>
</head>
<body>
    <!-- [HTML Anda yang sebelumnya tetap sama] -->

    <script>
        // ========== KONFIGURASI UTAMA ==========
        const membersKey = 'restaurantMembers';
        let currentScanner = null;
        let currentManagingMemberId = null;
        
        // ========== INISIALISASI ELEMEN ==========
        const sections = {
            scanSection: document.getElementById('scanSection'),
            addMemberSection: document.getElementById('addMemberSection'),
            manageMemberSection: document.getElementById('manageMemberSection'),
            listMembersSection: document.getElementById('listMembersSection')
        };
        
        const navButtons = {
            btnScan: document.getElementById('btnScan'),
            btnAddMember: document.getElementById('btnAddMember'),
            btnManageMember: document.getElementById('btnManageMember'),
            btnListMembers: document.getElementById('btnListMembers')
        };

        // ========== FUNGSI UTAMA ==========
        async function initializeQRScanner(containerId, onSuccess) {
            // Hentikan scanner sebelumnya jika ada
            await stopScanner();
            
            // Kosongkan container
            const container = document.getElementById(containerId);
            container.innerHTML = '<p class="info">Menyiapkan scanner...</p>';
            
            try {
                // Coba dapatkan daftar kamera
                const cameras = await Html5Qrcode.getCameras();
                let cameraConfig = { facingMode: "environment" }; // Default
                
                if (cameras && cameras.length > 0) {
                    // Prioritaskan kamera belakang
                    const backCamera = cameras.find(c => c.label.toLowerCase().includes('back'));
                    cameraConfig = backCamera ? { deviceId: backCamera.id } : { deviceId: cameras[0].id };
                }
                
                // Buat instance scanner baru
                const html5QrCode = new Html5Qrcode(containerId);
                
                // Konfigurasi scanner
                const config = { 
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    experimentalFeatures: {
                        useBarCodeDetectorIfSupported: true
                    },
                    rememberLastUsedCamera: true
                };
                
                // Mulai scanning
                await html5QrCode.start(
                    cameraConfig,
                    config,
                    (decodedText, decodedResult) => {
                        console.log('Scan berhasil:', decodedText);
                        onSuccess(decodedText, decodedResult);
                    },
                    (errorMessage) => {
                        console.warn('Scan error:', errorMessage);
                    }
                ).catch(err => {
                    console.error('Gagal memulai scanner:', err);
                    container.innerHTML = `<p class="error">Gagal memulai scanner: ${err.message}</p>`;
                    throw err;
                });
                
                currentScanner = html5QrCode;
                console.log('Scanner berhasil diinisialisasi');
                return html5QrCode;
            } catch (error) {
                console.error('Error inisialisasi scanner:', error);
                container.innerHTML = `
                    <p class="error">Gagal mengakses kamera:</p>
                    <p>${error.message}</p>
                    <button onclick="retryScanner('${containerId}')">Coba Lagi</button>
                `;
                return null;
            }
        }

        async function stopScanner() {
            if (currentScanner && currentScanner.isScanning) {
                try {
                    await currentScanner.stop();
                    console.log('Scanner berhasil dihentikan');
                } catch (err) {
                    console.warn('Gagal menghentikan scanner:', err);
                } finally {
                    currentScanner = null;
                }
            }
        }

        function retryScanner(containerId) {
            const currentSection = Object.keys(sections).find(
                key => sections[key].classList.contains('active')
            );
            switchSection(currentSection);
        }

        // ========== MANAJEMEN SECTION ==========
        async function switchSection(sectionId) {
            // Hentikan scanner aktif
            await stopScanner();
            
            // Sembunyikan semua section
            Object.values(sections).forEach(section => {
                section.classList.remove('active');
            });
            
            // Nonaktifkan semua tombol
            Object.values(navButtons).forEach(button => {
                button.classList.remove('active');
            });
            
            // Aktifkan section dan tombol yang dipilih
            sections[sectionId].classList.add('active');
            navButtons[`btn${sectionId.replace('Section', '')}`].classList.add('active');
            
            // Inisialisasi scanner sesuai section
            try {
                if (sectionId === 'scanSection') {
                    document.getElementById("result").innerHTML = "Hasil Scan Akan Muncul Di Sini";
                    await initializeQRScanner("reader", (text) => {
                        document.getElementById("result").innerHTML = `
                            <p><strong>Terdeteksi:</strong></p>
                            <p><a href="${text}" target="_blank">${text}</a></p>
                        `;
                    });
                }
                else if (sectionId === 'addMemberSection') {
                    document.getElementById('newMemberForm').style.display = 'none';
                    document.getElementById('newMemberQrResult').innerHTML = "Pindai QR untuk ID Member Baru";
                    await initializeQRScanner("qrScanForNewMember", (text) => {
                        const members = getMembers();
                        if (members[text]) {
                            showMessage('addMemberMessage', 'ID Member sudah terdaftar!', 'error');
                        } else {
                            stopScanner();
                            document.getElementById('newMemberQrResult').innerHTML = `
                                <p class="success">QR Code terdeteksi:</p>
                                <p><strong>${text}</strong></p>
                            `;
                            document.getElementById('newMemberId').value = text;
                            document.getElementById('newMemberForm').style.display = 'block';
                        }
                    });
                }
                else if (sectionId === 'manageMemberSection') {
                    document.getElementById('memberDetails').style.display = 'none';
                    document.getElementById('manageMemberQrResult').innerHTML = "Pindai Kartu Member";
                    await initializeQRScanner("qrScanForManageMember", (text) => {
                        const members = getMembers();
                        const member = members[text];
                        if (member) {
                            stopScanner();
                            currentManagingMemberId = text;
                            displayMemberDetails(member);
                        } else {
                            showMessage('manageMemberMessage', 'ID Member tidak ditemukan!', 'error');
                        }
                    });
                }
                else if (sectionId === 'listMembersSection') {
                    renderMemberList();
                }
            } catch (error) {
                console.error('Error saat mengubah section:', error);
            }
        }

        // ========== FUNGSI PENDUKUNG ==========
        function displayMemberDetails(member) {
            document.getElementById('memberNameDisplay').textContent = member.name;
            document.getElementById('memberIdDisplay').textContent = member.id;
            document.getElementById('memberPhoneDisplay').textContent = member.phone || '-';
            document.getElementById('memberEmailDisplay').textContent = member.email || '-';
            document.getElementById('memberTotalTransactionDisplay').textContent = 
                member.totalTransaction?.toLocaleString('id-ID') || '0';
            
            document.getElementById('editMemberName').value = member.name;
            document.getElementById('editMemberPhone').value = member.phone || '';
            document.getElementById('editMemberEmail').value = member.email || '';
            
            document.getElementById('memberDetails').style.display = 'block';
        }

        function getMembers() {
            const membersJson = localStorage.getItem(membersKey);
            return membersJson ? JSON.parse(membersJson) : {};
        }

        function saveMembers(members) {
            localStorage.setItem(membersKey, JSON.stringify(members));
        }

        function showMessage(elementId, message, type = 'info', timeout = 3000) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.textContent = message;
            element.className = `info-message ${type}`;
            
            if (element.timer) clearTimeout(element.timer);
            element.timer = setTimeout(() => {
                element.textContent = '';
                element.className = 'info-message';
            }, timeout);
        }

        // [Fungsi renderMemberList dan lainnya tetap sama seperti sebelumnya]

        // ========== EVENT LISTENERS ==========
        document.getElementById('newMemberForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const memberId = document.getElementById('newMemberId').value;
            const memberName = document.getElementById('newMemberName').value;
            
            if (!memberId || !memberName) {
                showMessage('addMemberMessage', 'ID dan Nama Member wajib diisi!', 'error');
                return;
            }
            
            const members = getMembers();
            if (members[memberId]) {
                showMessage('addMemberMessage', 'ID Member sudah terdaftar!', 'error');
                return;
            }
            
            members[memberId] = {
                id: memberId,
                name: memberName,
                phone: document.getElementById('newMemberPhone').value,
                email: document.getElementById('newMemberEmail').value,
                totalTransaction: 0
            };
            
            saveMembers(members);
            showMessage('addMemberMessage', 'Member baru berhasil ditambahkan!', 'success');
            
            // Reset form
            this.reset();
            this.style.display = 'none';
            await switchSection('addMemberSection');
        });

        // [Event listeners lainnya tetap sama]

        // ========== INISIALISASI AWAL ==========
        document.addEventListener('DOMContentLoaded', () => {
            // Tambahkan event listeners untuk navigasi
            Object.entries(navButtons).forEach(([id, button]) => {
                const sectionId = id.replace('btn', '') + 'Section';
                button.addEventListener('click', () => switchSection(sectionId));
            });
            
            // Mulai dengan section scan
            switchSection('scanSection');
            
            // Tambahkan handler untuk izin kamera
            document.addEventListener('click', async (e) => {
                if (e.target.classList.contains('retry-camera')) {
                    const currentSection = Object.keys(sections).find(
                        key => sections[key].classList.contains('active')
                    );
                    await switchSection(currentSection);
                }
            });
        });

        // Ekspos fungsi ke global scope untuk debugging
        window.debugScanner = {
            getCurrentScanner: () => currentScanner,
            stopScanner,
            switchSection
        };
    </script>
</body>
</html>