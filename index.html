<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Viewer Reservasi Dolan Sawah (Live Sync + Control)</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <style>
    :root {
      --primary: #2a9d8f; --primary-dark: #203a43; --secondary: #e9c46a; 
      --highlight: #d35400; --danger: #c0392b; --danger-light: #fadbd8;
      --bg-body: #f4f6f8; --bg-card: #ffffff; --text-main: #2d3436; --text-muted: #636e72;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Poppins', sans-serif; margin: 0; background-color: var(--bg-body); color: var(--text-main); overflow-x: hidden; padding-bottom: 80px; }
    
    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary)); padding: 15px 20px 40px; color: white;
      border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    .header-branding h2 { margin: 0; font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .header-branding small { opacity: 0.9; font-size: 0.8rem; margin-top: 4px; font-weight: 300; }
    
    .main-container { max-width: 800px; margin: -30px auto 0; padding: 0 15px; position: relative; z-index: 10; }
    .calendar-wrapper { background: var(--bg-card); border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 20px; }
    
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .month-year { font-size: 1.2rem; font-weight: 700; color: var(--primary-dark); text-transform: capitalize; }
    .calendar-nav button { background: #f1f2f6; border: 1px solid #e1e1e1; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
    
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .weekday { text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px; }
    
    .day-cell {
      aspect-ratio: 1/1; background: #ffffff; border: 1px solid #eaeaea; border-radius: 10px;
      position: relative; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 6px; overflow: hidden;
    }
    .day-num { font-weight: 600; font-size: 0.95rem; z-index: 2; line-height: 1; }
    
    .day-cell.today { background: var(--secondary); border: 2px solid #d4ac0d; color: white; }
    .day-cell.today .day-num { color: #fff; }
    .day-cell.has-res { background: #e0f2f1; border-color: var(--primary); }
    .day-cell.has-res .day-num { color: var(--primary-dark); }
    
    .res-indicator { margin-top: auto; margin-bottom: 6px; display: flex; flex-direction: column; align-items: center; gap: 2px; }
    .res-count { font-size: 0.6rem; color: var(--primary-dark); font-weight: 700; background: rgba(255,255,255,0.7); padding: 1px 4px; border-radius: 4px; }
    
    .day-cell.is-full { background: var(--danger-light); border: 2px solid var(--danger); opacity: 0.9; }
    .day-cell.is-full::after { content: 'FULL'; font-size: 0.65rem; color: white; background: var(--danger); font-weight: 800; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-20deg); padding: 2px 6px; border-radius: 4px; z-index: 5; }

    .legend { display: flex; justify-content: center; gap: 15px; margin-top: 25px; font-size: 0.75rem; color: var(--text-muted); flex-wrap: wrap; border-top: 1px dashed #eee; padding-top: 15px; }
    .dot { width: 12px; height: 12px; border-radius: 4px; display: inline-block; }

    /* Modal Detail */
    .detail-overlay, .admin-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(2px); }
    .detail-overlay.active, .admin-overlay.show { display: flex; }
    
    .detail-sheet { background: var(--bg-body); width: 100%; max-width: 600px; height: 85vh; border-top-left-radius: 25px; border-top-right-radius: 25px; display: flex; flex-direction: column; overflow: hidden; animation: slideUpBig 0.3s ease; }
    @keyframes slideUpBig { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    .sheet-header { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
    .sheet-content { flex: 1; overflow-y: auto; padding: 15px; }
    
    .loc-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #f0f0f0; }
    .loc-header { height: 100px; position: relative; background-size: cover; background-position: center; display: flex; align-items: flex-end; }
    .loc-title { background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); width: 100%; padding: 12px; color: white; display:flex; justify-content:space-between; align-items: flex-end; }
    .loc-badge { font-size: 0.7rem; background: rgba(255,255,255,0.2); backdrop-filter: blur(4px); padding: 4px 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); }
    
    .res-item { padding: 12px 15px; border-bottom: 1px dashed #ddd; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; background: white; }
    .res-qty { font-weight: 700; color: var(--primary); background: #e0f2f1; padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; }
    
    /* ADMIN FLOATING & MODAL */
    .floating-admin { position: fixed; bottom: 25px; right: 25px; background: var(--primary-dark); color: white; width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 25px rgba(0,0,0,0.3); z-index: 90; cursor: pointer; }
    .admin-modal { background: white; padding: 25px; width: 85%; max-width: 350px; border-radius: 20px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; display: none; }
    .admin-modal.show { display: block; }
    
    .btn-block { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .form-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; }
  </style>
</head>
<body>

  <header>
    <div class="header-branding">
      <h2><i class="fas fa-sync-alt"></i> Dolan Sawah Viewer</h2>
      <small>Live Sync + Admin Control</small>
    </div>
  </header>

  <div class="main-container">
    <div class="calendar-wrapper">
        <div class="calendar-header">
          <div class="month-year" id="monthYear">...</div>
          <div class="calendar-nav">
            <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
            <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
          </div>
        </div>
    
        <div style="display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 10px;">
            <div class="weekday">Min</div><div class="weekday">Sen</div><div class="weekday">Sel</div>
            <div class="weekday">Rab</div><div class="weekday">Kam</div><div class="weekday">Jum</div><div class="weekday">Sab</div>
        </div>
        
        <div class="calendar-days" id="calendar"></div>
        
        <div class="legend">
            <div style="display:flex; gap:5px; align-items:center;"><span class="dot" style="background:var(--secondary); border:1px solid #d4ac0d;"></span> Hari Ini</div>
            <div style="display:flex; gap:5px; align-items:center;"><span class="dot" style="background:var(--primary)"></span> Ada Reservasi</div>
            <div style="display:flex; gap:5px; align-items:center;"><span class="dot" style="background:var(--danger)"></span> Penuh</div>
        </div>
    </div>
    
    <div style="margin-top: 25px; text-align: center;">
        <a href="https://www.dolansawah.my.id" style="color: var(--text-muted); font-size: 0.9rem; text-decoration: none; padding: 10px 20px; background: white; border-radius: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: inline-flex; align-items: center; gap: 8px;">
             <i class="fas fa-external-link-alt"></i> Buka Website Admin Utama
        </a>
    </div>
  </div>

  <div class="floating-admin" id="adminBtn"><i class="fas fa-lock"></i></div>

  <div class="detail-overlay" id="detailOverlay">
      <div class="detail-sheet">
          <div class="sheet-header">
              <div><h3 id="sheetDate" style="margin:0; color:var(--primary-dark);">Detail</h3><span id="sheetStats" style="font-size:0.8rem; color:#666;">...</span></div>
              <button onclick="closeDetail()" style="background:#f1f2f6; border:none; width:35px; height:35px; border-radius:50%;"><i class="fas fa-times"></i></button>
          </div>
          <div class="sheet-content" id="locGrid"></div>
      </div>
  </div>

  <div class="admin-overlay" id="adminOverlay"></div>
  <div class="admin-modal" id="adminModal">
      <h3 style="margin-top:0; text-align:center; color:var(--primary-dark);"><i class="fas fa-shield-alt"></i> Kontrol Manual</h3>
      
      <div id="loginForm">
          <input type="email" id="adminEmail" class="form-input" placeholder="Email Admin">
          <input type="password" id="adminPass" class="form-input" placeholder="Password">
          <button class="btn-block" style="background:var(--primary); color:white;" id="btnLoginAction">Masuk</button>
          <button class="btn-block" onclick="closeAdmin()" style="background:#f0f0f0; color:#666;">Batal</button>
      </div>

      <div id="adminControls" style="display:none;">
          <p style="font-size:0.85rem; color:#666; text-align:center; margin-bottom:15px;">Gunakan ini untuk menutup tanggal secara manual (misal: Libur).</p>
          <input type="date" id="dateSelector" class="form-input">
          
          <div style="display:flex; gap:10px; margin-bottom:20px;">
              <button class="btn-block" id="markFullBtn" style="background:var(--danger); color:white; flex:1;">
                  <i class="fas fa-ban"></i> TUTUP
              </button>
              <button class="btn-block" id="markAvailableBtn" style="background:var(--secondary); color:white; flex:1;">
                  <i class="fas fa-check"></i> BUKA
              </button>
          </div>
          
          <button class="btn-block" onclick="firebase.auth().signOut()" style="background:#f1f2f6; color:#555; margin-top:15px;">Logout</button>
      </div>
  </div>

  <script>
    // 1. CONFIG FIREBASE (SAMA PERSIS DENGAN ADMIN UTAMA)
    const firebaseConfig = {
      apiKey: "AIzaSyA_c1tU70FM84Qi_f_aSaQ-YVLo_18lCkI",
      authDomain: "reservasi-dolan-sawah.firebaseapp.com",
      projectId: "reservasi-dolan-sawah",
      storageBucket: "reservasi-dolan-sawah.appspot.com",
      messagingSenderId: "213151400721",
      appId: "1:213151400721:web:e51b0d8cdd24206cf682b0"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const locationImages = {
        "Lantai 1 belakang": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764935931/IMG_7474_ve5qwo.jpg",
        "Gubug 3": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764935931/IMG_7477_bxsmc6.jpg",
        "Lantai 2": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764935931/IMG_7475_s9rtpo.jpg",
        "Lantai 1 depan": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764935935/IMG_7472_gd2zsf.jpg",
        "Pondok 2": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764936109/3ac34945-6aef-4921-8c08-f9cbf8ab4892_mfdft0.jpg",
        "Pondok 3": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764936110/49d5f9c2-da86-461e-bdca-ad04398bfd99_yturyb.jpg",
        "Pondok 1": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764936110/ae454394-906a-43d6-a3e7-7453e5ef91b7_fdzogh.jpg",
        "Lantai 3": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764935931/IMG_7479_dlgxmv.jpg",
        "Lantai 1 tengah": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764985452/IMG_7494_wyskxg.jpg",
        "Meeting room": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764985551/IMG_7491_shjtqx.jpg",
        "Lantai 1 Full Blok": "https://res.cloudinary.com/dn60ib3ur/image/upload/v1764985614/image_e2za88.jpg"
    };
    const defaultImage = "https://via.placeholder.com/300x200?text=Lokasi";
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let allReservations = {}; 
    let locationsConfig = {};
    let dateStatus = {}; // Menyimpan status manual (Penuh/Buka)
    let unsubscribeRes = null;
    let unsubscribeStatus = null;

    document.addEventListener('DOMContentLoaded', async () => {
        await loadLocations();
        setupRealtimeListeners();
        setupAdminLogic();
        
        document.getElementById('prevMonth').addEventListener('click', () => { 
            currentMonth--; if(currentMonth < 0) { currentMonth=11; currentYear--; } 
            setupRealtimeListeners(); 
        });
        document.getElementById('nextMonth').addEventListener('click', () => { 
            currentMonth++; if(currentMonth > 11) { currentMonth=0; currentYear++; } 
            setupRealtimeListeners(); 
        });
    });

    async function loadLocations() {
        try {
            const snap = await db.collection("locations").get();
            snap.forEach(doc => locationsConfig[doc.data().name] = doc.data().capacity);
        } catch(e) {}
    }

    // --- LISTENER GANDA (DATA RESERVASI + STATUS MANUAL) ---
    function setupRealtimeListeners() {
        if(unsubscribeRes) unsubscribeRes();
        if(unsubscribeStatus) unsubscribeStatus();

        const mStr = String(currentMonth + 1).padStart(2, '0');
        const start = `${currentYear}-${mStr}-01`;
        const end = `${currentYear}-${mStr}-31`;

        document.getElementById('calendar').innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px;">Memuat Data...</div>';
        document.getElementById('monthYear').textContent = `${monthNames[currentMonth]} ${currentYear}`;

        // 1. DENGAR DATA RESERVASI
        unsubscribeRes = db.collection("reservations")
            .where('date', '>=', start).where('date', '<=', end)
            .onSnapshot(snapshot => {
                allReservations = {};
                snapshot.forEach(doc => {
                    const r = doc.data();
                    if(!allReservations[r.date]) allReservations[r.date] = [];
                    allReservations[r.date].push(r);
                });
                renderCalendar();
            });
            
        // 2. DENGAR STATUS MANUAL (PENUH/LIBUR)
        // Kita simpan status manual di collection 'date_status' agar tidak campur
        unsubscribeStatus = db.collection("date_status")
             .where('date', '>=', start).where('date', '<=', end)
             .onSnapshot(snapshot => {
                 dateStatus = {};
                 snapshot.forEach(doc => {
                     dateStatus[doc.data().date] = doc.data().isFull;
                 });
                 renderCalendar();
             });
    }

    function renderCalendar() {
        const cal = document.getElementById('calendar');
        cal.innerHTML = '';
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const today = new Date();

        for(let i=0; i<firstDay; i++) cal.innerHTML += `<div></div>`;

        for(let i=1; i<=daysInMonth; i++) {
            const el = document.createElement('div');
            el.className = 'day-cell';
            
            const mStr = String(currentMonth + 1).padStart(2, '0');
            const dStr = String(i).padStart(2, '0');
            const dateKey = `${currentYear}-${mStr}-${dStr}`;
            
            const list = allReservations[dateKey] || [];
            const count = list.length;
            const total = list.reduce((s,r) => s + (parseInt(r.jumlah)||0), 0);
            
            // Cek Status Manual (Override)
            const isManualFull = dateStatus[dateKey] === true;

            if(i === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) el.classList.add('today');
            
            if(isManualFull) {
                el.classList.add('is-full');
            } else if(count > 0) {
                el.classList.add('has-res');
                el.innerHTML = `<span class="day-num">${i}</span><div class="res-indicator"><div class="res-count">${total}</div></div>`;
            } else {
                el.innerHTML = `<span class="day-num">${i}</span>`;
            }

            el.onclick = () => openDetail(i, list);
            cal.appendChild(el);
        }
    }

    function openDetail(day, list) {
        document.getElementById('detailOverlay').classList.add('active');
        document.getElementById('sheetDate').textContent = `${day} ${monthNames[currentMonth]} ${currentYear}`;
        document.getElementById('sheetStats').textContent = list.length ? `${list.length} Grup Reservasi` : 'Tidak ada reservasi';
        
        const grid = document.getElementById('locGrid');
        grid.innerHTML = '';
        
        if(list.length === 0) {
            grid.innerHTML = '<div style="text-align:center; padding:30px; color:#aaa;">Data Kosong</div>';
            return;
        }

        const grouped = {};
        list.forEach(r => {
            const l = r.tempat || 'Lainnya';
            if(!grouped[l]) grouped[l] = [];
            grouped[l].push(r);
        });

        Object.keys(grouped).sort().forEach(loc => {
            const items = grouped[loc];
            const img = locationImages[loc] || defaultImage;
            const cap = locationsConfig[loc] || '-';
            const curr = items.reduce((s,r)=>s+(parseInt(r.jumlah)||0),0);

            let htmlItems = '';
            items.sort((a,b)=> (a.jam||'').localeCompare(b.jam||'')).forEach(r => {
                let menuText = '';
                if(r.menus && Array.isArray(r.menus)) menuText = r.menus.map(m => m.quantity + 'x ' + m.name).join(', ');
                else if (r.menu) menuText = r.menu;

                htmlItems += `<div class="res-item"><div><strong>${r.nama}</strong><small><i class="far fa-clock"></i> ${r.jam} WIB ${r.nomorHp ? '| ' + r.nomorHp : ''}</small><div style="font-size:0.75rem; color:#666; margin-top:2px;">${menuText}</div></div><span class="res-qty">${r.jumlah}</span></div>`;
            });

            const card = document.createElement('div');
            card.className = 'loc-card';
            card.innerHTML = `<div class="loc-header" style="background-image:url('${img}')"><div class="loc-title"><span class="loc-name">${loc}</span><span class="loc-badge">${curr} / ${cap}</span></div></div><button class="btn-toggle-loc" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display==='block'?'none':'block'">Lihat ${items.length} Reservasi</button><div class="loc-body">${htmlItems}</div>`;
            grid.appendChild(card);
        });
    }
    
    function closeDetail() { document.getElementById('detailOverlay').classList.remove('active'); }
    
    // LOGIKA ADMIN (HANYA UNTUK SET STATUS MANUAL)
    function setupAdminLogic() {
        const btn = document.getElementById('adminBtn');
        const overlay = document.getElementById('adminOverlay');
        const modal = document.getElementById('adminModal');
        
        const open = () => { overlay.classList.add('show'); modal.classList.add('show'); };
        window.closeAdmin = () => { overlay.classList.remove('show'); modal.classList.remove('show'); };
        
        btn.onclick = open;
        overlay.onclick = window.closeAdmin;
        
        auth.onAuthStateChanged(user => {
            document.getElementById('loginForm').style.display = user ? 'none' : 'block';
            document.getElementById('adminControls').style.display = user ? 'block' : 'none';
        });

        document.getElementById('btnLoginAction').onclick = () => {
            const e = document.getElementById('adminEmail').value;
            const p = document.getElementById('adminPass').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => alert("Login Gagal: " + err.message));
        };

        const updateStatus = async (isFull) => {
            const d = document.getElementById('dateSelector').value;
            if(!d) return alert("Pilih tanggal dulu");
            
            // Simpan ke collection khusus 'date_status'
            // Format ID: YYYY-MM-DD
            try {
                await db.collection("date_status").doc(d).set({
                    date: d,
                    isFull: isFull
                }, { merge: true });
                alert("Status Berhasil Diupdate!");
            } catch(e) { alert("Error: " + e.message); }
        };

        document.getElementById('markFullBtn').onclick = () => updateStatus(true);
        document.getElementById('markAvailableBtn').onclick = () => updateStatus(false);
    }
  </script>
</body>
</html>
